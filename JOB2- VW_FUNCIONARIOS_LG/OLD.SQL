CREATE OR REPLACE VIEW VW_FUNCIONARIOS_LG AS
WITH PESSOA AS
 (SELECT P.ID_PESSOA, P.CPF, P.NOME, PA.FUNCIONARIO
    FROM TB_PESSOA P, TB_PESSOA_ATRIBUTO PA
   WHERE P.ID_PESSOA = PA.ID_PESSOA),

FUNCIONARIOS AS
 (SELECT TO_NUMBER(CT.CPF_PESSOA) AS CPF_PESSOA,
         'S' AS EH_FUNCIONARIO,
         CT.DESCRICAO_ESTABELECIMENTO
    FROM LG.TB_CONTRATO_TRABALHO@LG CT, LG.TB_SITUACAO@LG S
   WHERE CT.ID_SITUACAO_COLABORADOR = S.ID_SITUACAO
     AND CT.ID_CATEGORIA NOT IN (701)
     AND S.TIPO != 5)

SELECT A.ID_PESSOA,
       A.CPF,
       A.NOME,
       A.FUNCIONARIO,
       NVL(B.EH_FUNCIONARIO, 'N') AS SIT_FUNCIONARIO
  FROM PESSOA A
  LEFT JOIN FUNCIONARIOS B
    ON (A.CPF = B.CPF_PESSOA)
 WHERE /*A.CPF = '18683178897'
   AND*/ NVL(A.FUNCIONARIO, '0') != NVL(B.EH_FUNCIONARIO, 'N');
